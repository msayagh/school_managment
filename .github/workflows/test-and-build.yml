name: Test and Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-services:
    name: Test Microservices
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        service: [students, teachers, activities, rooms, bookings, api-gateway]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'services/${{ matrix.service }}/package-lock.json'
    
    - name: Install shared dependencies
      run: |
        cd shared
        npm install
    
    - name: Install service dependencies
      run: |
        cd services/${{ matrix.service }}
        npm install
    
    - name: Run tests
      run: |
        cd services/${{ matrix.service }}
        npm test
      env:
        NODE_ENV: test
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        files: ./services/${{ matrix.service }}/coverage/coverage-final.json
        flags: ${{ matrix.service }}
        name: ${{ matrix.service }}-coverage

  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: test-services
    if: github.event_name == 'push'
    
    strategy:
      matrix:
        service: [students, teachers, activities, rooms, bookings, api-gateway]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Docker image
      run: |
        docker build -f services/${{ matrix.service }}/Dockerfile -t school-${{ matrix.service }}:latest .
    
    - name: Save Docker image
      run: |
        docker save school-${{ matrix.service }}:latest | gzip > ${{ matrix.service }}-image.tar.gz
    
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.service }}-image
        path: ${{ matrix.service }}-image.tar.gz
        retention-days: 1

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test-services
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: rootpassword
          MYSQL_DATABASE: school_management
          MYSQL_USER: school_admin
          MYSQL_PASSWORD: changeme
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Wait for MySQL
      run: |
        for i in {1..30}; do
          if mysqladmin ping -h 127.0.0.1 -u root -prootpassword; then
            echo "MySQL is up"
            break
          fi
          echo "Waiting for MySQL..."
          sleep 2
        done
    
    - name: Initialize database
      run: |
        mysql -h 127.0.0.1 -u root -prootpassword school_management < services/database/init/01-schema.sql
    
    - name: Install dependencies
      run: |
        cd shared && npm install
        cd ../services/students && npm install
        cd ../teachers && npm install
        cd ../activities && npm install
        cd ../rooms && npm install
        cd ../bookings && npm install
        cd ../api-gateway && npm install
    
    - name: Run integration tests
      run: |
        echo "Integration tests would run here"
        # Add integration test commands here when implemented
      env:
        DB_HOST: 127.0.0.1
        DB_PORT: 3306
        DB_USER: school_admin
        DB_PASSWORD: changeme
        DB_NAME: school_management
        JWT_SECRET: test-secret-key
