<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>School Management System ‚Äî Admin</title>
  <style>
    /* ===== RESET & BASE ===== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --primary: #5e35b1;
      --primary-light: #7e57c2;
      --primary-dark: #4527a0;
      --accent: #ff6f00;
      --accent-light: #ff9800;
      --danger: #d32f2f;
      --success: #388e3c;
      --warning: #f57c00;
      --info: #0097a7;
      --bg: #f5f7fa;
      --bg-dark: #eeeff2;
      --card: #fff;
      --border: #d0d4db;
      --text: #1a1a2e;
      --text-muted: #5a5a7a;
      --sidebar-width: 240px;
      --gradient-purple: linear-gradient(135deg, #5e35b1 0%, #7e57c2 100%);
      --gradient-blue: linear-gradient(135deg, #0097a7 0%, #00bcd4 100%);
      --gradient-success: linear-gradient(135deg, #388e3c 0%, #4caf50 100%);
      --gradient-danger: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

    /* ===== AUTH SCREEN ===== */
    #auth-screen {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
    }
    .auth-box {
      background: white; border-radius: 12px; padding: 2.5rem; width: 100%; max-width: 420px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .auth-logo { text-align: center; margin-bottom: 1.5rem; }
    .auth-logo h1 { color: var(--primary); font-size: 1.6rem; }
    .auth-logo p { color: var(--text-muted); font-size: 0.9rem; margin-top: 0.3rem; }
    .tab-bar { display: flex; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border); }
    .tab-btn {
      flex: 1; padding: 0.6rem; background: none; border: none; cursor: pointer;
      font-size: 0.95rem; color: var(--text-muted); font-weight: 500;
      border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.2s;
    }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.3rem; }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 0.65rem 0.9rem; border: 1.5px solid var(--border); border-radius: 8px;
      font-size: 0.95rem; transition: border-color 0.2s; outline: none; font-family: inherit;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--primary-light); }
    .btn {
      display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.6rem 1.2rem;
      border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600;
      transition: all 0.2s; text-decoration: none;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-light); }
    .btn-accent { background: var(--accent); color: white; }
    .btn-accent:hover { background: #e65c00; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover { background: #b71c1c; }
    .btn-ghost { background: transparent; border: 1.5px solid var(--border); color: var(--text); }
    .btn-ghost:hover { background: var(--bg); }
    .btn-sm { padding: 0.35rem 0.75rem; font-size: 0.8rem; }
    .btn-full { width: 100%; justify-content: center; }
    .alert { padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem; }
    .alert-error { background: #ffebee; color: var(--danger); border: 1px solid #ffcdd2; }
    .alert-success { background: #e8f5e9; color: var(--success); border: 1px solid #c8e6c9; }

    /* ===== APP LAYOUT ===== */
    #app { display: none; min-height: 100vh; }
    #app.visible { display: flex; }

    /* ===== SIDEBAR ===== */
    .sidebar {
      width: var(--sidebar-width); background: var(--primary); color: white;
      display: flex; flex-direction: column; position: fixed; top: 0; left: 0; bottom: 0;
      overflow-y: auto;
    }
    .sidebar-logo { padding: 1.25rem 1.2rem; border-bottom: 1px solid rgba(255,255,255,0.15); }
    .sidebar-logo h2 { font-size: 1rem; font-weight: 700; }
    .sidebar-logo p { font-size: 0.75rem; opacity: 0.7; margin-top: 0.15rem; }
    .sidebar-nav { flex: 1; padding: 0.75rem 0; }
    .nav-section { padding: 0.75rem 1.2rem 0.3rem; font-size: 0.7rem; font-weight: 700; opacity: 0.5; text-transform: uppercase; letter-spacing: 0.1em; }
    .nav-item {
      display: flex; align-items: center; gap: 0.75rem; padding: 0.65rem 1.2rem;
      cursor: pointer; font-size: 0.9rem; opacity: 0.8; transition: all 0.15s;
      text-decoration: none; color: white; border-left: 3px solid transparent;
    }
    .nav-item:hover { opacity: 1; background: rgba(255,255,255,0.08); }
    .nav-item.active { opacity: 1; background: rgba(255,255,255,0.15); border-left-color: white; }
    .nav-icon { font-size: 1.1rem; width: 1.4rem; text-align: center; }
    .sidebar-footer { padding: 1rem 1.2rem; border-top: 1px solid rgba(255,255,255,0.15); font-size: 0.8rem; opacity: 0.7; }
    .sidebar-user { display: flex; align-items: center; gap: 0.6rem; margin-bottom: 0.5rem; }
    .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 700; }
    .logout-btn { width: 100%; padding: 0.4rem; background: rgba(255,255,255,0.1); border: none; color: white; border-radius: 6px; cursor: pointer; font-size: 0.8rem; transition: background 0.2s; }
    .logout-btn:hover { background: rgba(255,255,255,0.2); }

    /* ===== MAIN CONTENT ===== */
    .main { margin-left: var(--sidebar-width); flex: 1; display: flex; flex-direction: column; min-height: 100vh; }
    .topbar {
      background: white; padding: 0.9rem 1.75rem; display: flex; align-items: center;
      justify-content: space-between; border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 10;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .topbar h1 { font-size: 1.25rem; font-weight: 700; color: var(--primary); margin: 0; }
    .topbar-center { display: flex; align-items: center; gap: 1.5rem; flex: 1; justify-content: center; }
    .date-picker-group { display: flex; align-items: center; gap: 0.75rem; }
    .date-picker-group label { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); white-space: nowrap; }
    .date-picker-group input { padding: 0.45rem 0.75rem; border: 1.5px solid var(--border); border-radius: 6px; font-size: 0.9rem; outline: none; transition: all 0.2s; }
    .date-picker-group input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(94, 53, 177, 0.1); }
    .topbar-actions { display: flex; align-items: center; gap: 1rem; }
    .content { padding: 1.75rem; flex: 1; }

    /* ===== PAGE ===== */
    .page { display: none; }
    .page.active { display: block; }
    
    .dashboard-tab { display: none; }
    .dashboard-tab.active { display: block; }
    .page-tab-btn {
      padding: 0.7rem 1rem; background: none; border: none; cursor: pointer;
      font-size: 0.9rem; color: var(--text-muted); font-weight: 600;
      border-bottom: 2px solid transparent; transition: all 0.2s;
    }
    .page-tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

    /* ===== DASHBOARD ===== */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.25rem; margin-bottom: 1.75rem; }
    .stat-card {
      background: white; border-radius: 12px; padding: 1.25rem 1.5rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07); display: flex; align-items: center; gap: 1rem;
    }
    .stat-icon { font-size: 2rem; width: 3rem; height: 3rem; display: flex; align-items: center; justify-content: center; border-radius: 10px; }
    .stat-info { flex: 1; }
    .stat-value { font-size: 1.8rem; font-weight: 700; line-height: 1; color: var(--primary); }
    .stat-label { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; }

    /* ===== CREATIVE DASHBOARD ===== */
    .scheduler-grid { display: grid; grid-template-columns: 1fr 300px; gap: 1.5rem; margin-bottom: 1.5rem; }
    .scheduler-main { display: flex; flex-direction: column; gap: 1.5rem; }
    .room-map-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; padding: 1.5rem; }
    .room-tile {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      border-radius: 12px; padding: 1.25rem; cursor: pointer;
      transition: all 0.3s; position: relative; overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 3px solid transparent;
    }
    .room-tile:hover { transform: translateY(-4px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
    .room-tile.selected { border-color: var(--primary); transform: scale(1.05); box-shadow: 0 8px 24px rgba(26, 35, 126, 0.3); }
    .room-tile.available { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); }
    .room-tile.partially-busy { background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); }
    .room-tile.busy { background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); }
    .room-tile-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; }
    .room-name { font-size: 1.1rem; font-weight: 700; color: var(--primary); }
    .room-capacity { font-size: 0.75rem; color: var(--text-muted); background: rgba(255,255,255,0.7); padding: 0.2rem 0.5rem; border-radius: 12px; }
    .room-status { font-size: 0.8rem; font-weight: 600; margin-top: 0.5rem; }
    .room-bookings { margin-top: 0.75rem; font-size: 0.75rem; color: var(--text-muted); }
    .room-booking-item { background: rgba(255,255,255,0.5); padding: 0.35rem 0.5rem; border-radius: 6px; margin-top: 0.35rem; font-size: 0.7rem; }
    
    .activity-selector { padding: 1.5rem; }
    .activity-list { display: flex; flex-direction: column; gap: 0.75rem; }
    .activity-card {
      background: white; border: 2px solid var(--border); border-radius: 10px; padding: 1rem;
      cursor: pointer; transition: all 0.2s; position: relative;
    }
    .activity-card:hover { border-color: var(--primary-light); background: #f8f9ff; }
    .activity-card.selected { border-color: var(--primary); background: #e8eaf6; }
    .activity-card-header { display: flex; align-items: start; gap: 0.75rem; }
    .activity-icon { font-size: 1.5rem; }
    .activity-info { flex: 1; }
    .activity-name { font-weight: 700; color: var(--primary); margin-bottom: 0.25rem; }
    .activity-details { font-size: 0.75rem; color: var(--text-muted); }
    .activity-capacity { font-size: 0.7rem; background: var(--bg); padding: 0.2rem 0.5rem; border-radius: 8px; display: inline-block; margin-top: 0.35rem; }
    
    .teacher-sidebar { display: flex; flex-direction: column; gap: 1rem; }
    .teacher-availability { padding: 1.5rem; max-height: 600px; overflow-y: auto; }
    .teacher-card {
      background: white; border-radius: 10px; padding: 1rem; margin-bottom: 0.75rem;
      border: 2px solid var(--border); transition: all 0.2s; cursor: pointer;
    }
    .teacher-card:hover { border-color: var(--success); transform: translateX(4px); }
    .teacher-card.available { border-color: var(--success); background: #f1f8f4; }
    .teacher-card.selected { border-color: var(--primary); background: #e8eaf6; box-shadow: 0 4px 12px rgba(26, 35, 126, 0.2); }
    .teacher-card-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
    .teacher-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1rem; }
    .teacher-info { flex: 1; }
    .teacher-name { font-weight: 700; font-size: 0.9rem; color: var(--primary); }
    .teacher-status { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.15rem; }
    .availability-badge { display: inline-flex; align-items: center; gap: 0.3rem; font-size: 0.7rem; font-weight: 600; padding: 0.25rem 0.5rem; border-radius: 12px; }
    .availability-badge.free { background: #e8f5e9; color: var(--success); }
    .availability-badge.busy { background: #ffebee; color: var(--danger); }
    
    .time-selector { padding: 1.5rem; }
    .time-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-top: 1rem; }
    .time-slot {
      padding: 0.6rem; border-radius: 8px; background: var(--bg);
      border: 2px solid transparent; cursor: pointer; text-align: center;
      font-size: 0.8rem; font-weight: 600; transition: all 0.2s;
    }
    .time-slot:hover { background: #e8eaf6; border-color: var(--primary-light); }
    .time-slot.selected { background: var(--primary); color: white; border-color: var(--primary); }
    .time-slot.unavailable { background: #f5f5f5; color: #ccc; cursor: not-allowed; }
    
    .schedule-action { padding: 1.5rem; border-top: 2px solid var(--border); background: #fafafa; }
    .schedule-btn { width: 100%; padding: 1rem; font-size: 1rem; }
    
    /* ===== CALENDAR ===== */
    .calendar-container { display: flex; flex-direction: column; padding: 1.5rem; gap: 1rem; }
    .calendar-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
    .calendar-nav button { padding: 0.5rem 1rem; background: var(--gradient-purple); color: white; border: none; border-radius: 999px; font-size: 0.9rem; cursor: pointer; box-shadow: 0 4px 14px rgba(94, 53, 177, 0.25); }
    .calendar-nav button:hover { background: var(--primary-dark); }
    .calendar-nav h3 { font-size: 1.1rem; font-weight: 700; color: var(--primary); text-align: center; flex: 1; }
    .calendar-legend { display: flex; gap: 0.6rem; flex-wrap: wrap; margin-bottom: 0.5rem; }
    .calendar-legend span { font-size: 0.75rem; padding: 0.25rem 0.55rem; border-radius: 999px; font-weight: 600; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.65rem; background: #f3f5fb; padding: 0.7rem; border-radius: 14px; }
    .calendar-day-header { padding: 0.65rem; text-align: center; font-weight: 700; font-size: 0.75rem; color: #fff; background: var(--gradient-purple); border-radius: 10px; letter-spacing: 0.03em; }
    .calendar-day { min-height: 112px; border: 1.5px solid #e5e9f2; border-radius: 10px; padding: 0.5rem; background: white; transition: all 0.2s; box-shadow: 0 2px 10px rgba(0,0,0,0.04); }
    .calendar-day.other-month { background: var(--bg-dark); opacity: 0.5; }
    .calendar-day.today { background: linear-gradient(135deg, #e8eaf6 0%, #f3e5f5 100%); border-color: var(--primary); }
    .calendar-day-num { font-weight: 700; font-size: 0.9rem; color: var(--text); margin-bottom: 0.4rem; }
    .calendar-slot { font-size: 0.7rem; padding: 0.3rem 0.4rem; margin-bottom: 0.25rem; border-radius: 6px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; transition: all 0.2s; border-left: 3px solid rgba(0,0,0,0.08); }
    .calendar-slot:hover { transform: scale(1.05); }
    .calendar-slot.confirmed { background: #c8e6c9; color: #2e7d32; }
    .calendar-slot.pending { background: #ffe0b2; color: #f57f17; }
    .calendar-slot.cancelled { background: #ffcdd2; color: #d32f2f; }
    .header-actions { display: flex; gap: 0.4rem; flex-wrap: wrap; align-items: center; }
    
    .enrollment-card { background: white; border: 2px solid var(--border); border-radius: 10px; padding: 1rem; margin-bottom: 1rem; transition: all 0.2s; }
    .enrollment-card:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(94, 53, 177, 0.1); }
    .enrollment-header { display: flex; align-items: start; gap: 0.75rem; margin-bottom: 0.75rem; }
    .enrollment-icon { font-size: 1.5rem; }
    .enrollment-info { flex: 1; }
    .enrollment-title { font-weight: 700; color: var(--primary); margin-bottom: 0.25rem; }
    .enrollment-meta { font-size: 0.8rem; color: var(--text-muted); }
    .enrollment-status { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 20px; font-size: 0.7rem; font-weight: 600; margin-top: 0.5rem; }
    .enrollment-status.active { background: #e8f5e9; color: var(--success); }
    .enrollment-status.completed { background: #e3f2fd; color: var(--info); }
    .enrollment-status.dropped { background: #ffebee; color: var(--danger); }
    
    .teacher-activity-card { background: white; border: 2px solid var(--border); border-radius: 10px; padding: 1rem; margin-bottom: 1rem; transition: all 0.2s; }
    .teacher-activity-card:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(94, 53, 177, 0.1); }
    .teacher-activity-time { font-size: 0.8rem; color: var(--text-muted); font-weight: 600; margin-bottom: 0.5rem; }
    .teacher-activity-title { font-weight: 700; color: var(--primary); margin-bottom: 0.25rem; }
    .teacher-activity-room { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; }
    .teacher-activity-status { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 20px; font-size: 0.7rem; font-weight: 600; }
    .teacher-activity-status.ongoing { background: #fff3e0; color: var(--warning); }
    .teacher-activity-status.upcoming { background: #e3f2fd; color: var(--info); }
    .teacher-activity-status.completed { background: #e8f5e9; color: var(--success); }
    
    @media (max-width: 1024px) {
      .scheduler-grid { grid-template-columns: 1fr; }
      .teacher-sidebar { display: grid; grid-template-columns: 1fr; gap: 1rem; }
      .time-grid { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 768px) {
      .room-map-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
      .teacher-sidebar { grid-template-columns: 1fr; }
      .time-grid { grid-template-columns: repeat(2, 1fr); }
    }

    /* ===== TABLES ===== */
    .card { background: white; border-radius: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.07); overflow: hidden; }
    .card-header { padding: 1.1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); }
    .card-header h2 { font-size: 1rem; font-weight: 700; }
    .card-body { padding: 0; }
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    th { background: var(--bg); padding: 0.7rem 1rem; text-align: left; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); border-bottom: 1px solid var(--border); }
    td { padding: 0.75rem 1rem; border-bottom: 1px solid #f5f5f5; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #fafafa; }
    .badge { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
    .badge-green { background: #e8f5e9; color: var(--success); }
    .badge-red { background: #ffebee; color: var(--danger); }
    .badge-orange { background: #fff3e0; color: var(--warning); }
    .badge-blue { background: #e3f2fd; color: #1565c0; }
    .badge-grey { background: #f5f5f5; color: #757575; }
    .actions { display: flex; gap: 0.4rem; flex-wrap: nowrap; }
    .empty-state { text-align: center; padding: 3rem; color: var(--text-muted); }
    .empty-state .icon { font-size: 3rem; margin-bottom: 0.75rem; }
    .search-bar { display: flex; gap: 0.75rem; margin-bottom: 1.25rem; flex-wrap: wrap; }
    .search-bar input { flex: 1; min-width: 200px; padding: 0.6rem 0.9rem; border: 1.5px solid var(--border); border-radius: 8px; font-size: 0.9rem; outline: none; }
    .search-bar input:focus { border-color: var(--primary-light); }

    /* ===== MODAL ===== */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex;
      align-items: center; justify-content: center; z-index: 1000; padding: 1rem;
    }
    .modal { background: white; border-radius: 12px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .modal-lg { max-width: 700px; }
    .modal-header { padding: 1.25rem 1.5rem; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: white; }
    .modal-header h3 { font-size: 1.05rem; font-weight: 700; }
    .modal-close { background: none; border: none; font-size: 1.25rem; cursor: pointer; color: var(--text-muted); line-height: 1; }
    .modal-body { padding: 1.5rem; }
    .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 0.75rem; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

    /* ===== TOAST ===== */
    #toast {
      position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 2000;
      padding: 0.75rem 1.25rem; border-radius: 10px; font-size: 0.9rem; font-weight: 500;
      color: white; min-width: 220px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      transform: translateY(0); transition: all 0.3s; opacity: 1;
    }
    #toast.hide { opacity: 0; transform: translateY(20px); pointer-events: none; }
    #toast.success { background: var(--success); }
    #toast.error { background: var(--danger); }
    #toast.info { background: var(--primary-light); }

    /* ===== LOADING ===== */
    .loading { display: flex; align-items: center; justify-content: center; padding: 2rem; color: var(--text-muted); gap: 0.5rem; }
    .spinner { width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.7s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); transition: transform 0.3s; z-index: 100; }
      .sidebar.open { transform: none; }
      .main { margin-left: 0; }
      .form-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div class="auth-box">
    <div class="auth-logo">
      <h1>üè´ School Management</h1>
      <p>Admin Dashboard</p>
    </div>
    <div class="tab-bar">
      <button class="tab-btn active" onclick="showTab('login')">Login</button>
      <button class="tab-btn" onclick="showTab('register')">Register</button>
    </div>
    <div id="auth-error" class="alert alert-error" style="display:none"></div>

    <!-- Login Form -->
    <form id="login-form" onsubmit="doLogin(event)">
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="login-username" placeholder="admin" required autocomplete="username">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
      </div>
      <button type="submit" class="btn btn-primary btn-full">Sign In</button>
    </form>

    <!-- Register Form -->
    <form id="register-form" style="display:none" onsubmit="doRegister(event)">
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="reg-username" placeholder="admin" required>
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="reg-email" placeholder="admin@school.com" required>
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="reg-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6">
      </div>
      <div class="form-group">
        <label>Role</label>
        <select id="reg-role">
          <option value="admin">Admin</option>
          <option value="teacher">Teacher</option>
          <option value="student">Student</option>
        </select>
      </div>
      <button type="submit" class="btn btn-primary btn-full">Create Account</button>
    </form>
  </div>
</div>

<!-- APP -->
<div id="app">
  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <h2>üè´ School Mgmt</h2>
      <p>Admin Dashboard</p>
    </div>
    <div class="sidebar-nav">
      <div class="nav-section">Overview</div>
      <a class="nav-item active" data-page="dashboard" onclick="navigate('dashboard')">
        <span class="nav-icon">üìä</span> Dashboard
      </a>
      <div class="nav-section">Management</div>
      <a class="nav-item" data-page="students" onclick="navigate('students')">
        <span class="nav-icon">üë®‚Äçüéì</span> Students
      </a>
      <a class="nav-item" data-page="teachers" onclick="navigate('teachers')">
        <span class="nav-icon">üë©‚Äç</span> Teachers
      </a>
      <a class="nav-item" data-page="activities" onclick="navigate('activities')">
        <span class="nav-icon">üìö</span> Activities
      </a>
      <a class="nav-item" data-page="rooms" onclick="navigate('rooms')">
        <span class="nav-icon">üèõÔ∏è</span> Rooms
      </a>
      <a class="nav-item" data-page="bookings" onclick="navigate('bookings')">
        <span class="nav-icon">üìÖ</span> Bookings
      </a>
    </div>
    <div class="sidebar-footer">
      <div class="sidebar-user">
        <div class="user-avatar" id="user-avatar">A</div>
        <div>
          <div id="user-name" style="font-weight:600">Admin</div>
          <div id="user-role" style="font-size:0.7rem;opacity:0.7">admin</div>
        </div>
      </div>
      <button class="logout-btn" onclick="logout()">‚èª Sign Out</button>
    </div>
  </nav>

  <!-- Main -->
  <div class="main">
    <div class="topbar">
      <h1 id="page-title">Dashboard</h1>
      <div class="topbar-center" id="topbar-center">
        <div class="date-picker-group">
          <label for="global-date-picker">üèõÔ∏è Room Map Date:</label>
          <input type="date" id="global-date-picker" onchange="onGlobalDateChange()">
        </div>
      </div>
      <div class="topbar-actions" id="topbar-actions"></div>
    </div>
    <div class="content">

      <!-- DASHBOARD PAGE -->
      <div class="page active" id="page-dashboard">
        <!-- Dashboard Tabs -->
        <div style="border-bottom: 2px solid var(--border); margin-bottom: 1.5rem;">
          <div class="tab-bar" style="margin-bottom: 0; border-bottom: none;">
            <button class="page-tab-btn active" onclick="switchDashboardTab('schedule', this)" style="margin-bottom: 0; padding: 1rem 1.5rem;">üìÖ Schedule Board</button>
            <button class="page-tab-btn" onclick="switchDashboardTab('calendar', this)" style="margin-bottom: 0; padding: 1rem 1.5rem;">üóìÔ∏è Calendar View</button>
          </div>
        </div>
        
        <!-- Schedule Tab -->
        <div id="dashboard-schedule" class="dashboard-tab active">
        <div class="scheduler-grid">
          <div class="scheduler-main">
            <!-- Room Map -->
            <div class="card">
              <div class="card-header">
                <h2>üèõÔ∏è Room Availability Map</h2>
                <span id="current-time-display" style="font-size:0.8rem; color:var(--text-muted);"></span>
              </div>
              <div class="card-body room-map-grid" id="room-map">
                <div class="loading"><div class="spinner"></div> Loading rooms‚Ä¶</div>
              </div>
            </div>
            
            <!-- Activity Selector -->
            <div class="card">
              <div class="card-header">
                <h2>üìö Select Activity to Schedule</h2>
              </div>
              <div class="card-body activity-selector">
                <div class="activity-list" id="activity-list">
                  <div class="loading"><div class="spinner"></div> Loading activities‚Ä¶</div>
                </div>
              </div>
            </div>
            
            <!-- Teacher Availability -->
            <div class="card">
              <div class="card-header">
                <h2>üë©‚Äçüè´ Available Teachers</h2>
              </div>
              <div class="card-body teacher-availability" id="dashboard-teacher-list">
                <div class="loading"><div class="spinner"></div> Loading teachers‚Ä¶</div>
              </div>
            </div>
          </div>
          
          <div class="teacher-sidebar">
            <!-- Time Selector -->
            <div class="card">
              <div class="card-header">
                <h2>‚è∞ Schedule a Quick Activity?</h2>
              </div>
              <div class="card-body time-selector">
                <div id="selected-activity-info" style="font-size:0.85rem; color:var(--text-muted); margin-bottom:1rem;">
                  Select an activity to see available time slots
                </div>
                
                <!-- Time Grid -->
                <div style="margin-bottom: 1rem;">
                  <label style="display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem;">Time Slot:</label>
                  <div class="time-grid" id="time-grid">
                  </div>
                </div>
              </div>
              <div class="schedule-action">
                <button class="btn btn-primary schedule-btn" id="schedule-btn" disabled onclick="scheduleActivity()">
                  üìÖ Schedule Activity
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
        
        <!-- Calendar Tab -->
        <div id="dashboard-calendar" class="dashboard-tab">
          <div class="card">
            <div class="card-header">
              <h2>üìÖ Monthly Calendar View</h2>
              <p style="font-size: 0.8rem; color: var(--text-muted);">All bookings and activities</p>
            </div>
            <div class="card-body calendar-container" id="calendar-view">
              <div class="loading"><div class="spinner"></div> Loading calendar‚Ä¶</div>
            </div>
          </div>
        </div>
      </div>

      <!-- STUDENTS PAGE -->
      <div class="page" id="page-students">
        <div class="search-bar">
          <input type="text" id="students-search" placeholder="Search by name or email‚Ä¶" oninput="filterTable('students')">
        </div>
        <div class="card">
          <div class="card-header">
            <h2>Students</h2>
            <div class="header-actions">
              <button class="btn btn-ghost btn-sm" onclick="exportCsv('students')">‚¨á Export CSV</button>
              <button class="btn btn-ghost btn-sm" onclick="triggerCsvImport('students')">‚¨Ü Import CSV</button>
              <button class="btn btn-ghost btn-sm" onclick="openEnrollmentModal(null, true)">üìã Bulk Enroll</button>
              <button class="btn btn-accent btn-sm" onclick="openStudentModal()">+ Add Student</button>
            </div>
          </div>
          <div class="card-body table-wrap">
            <div id="students-table"><div class="loading"><div class="spinner"></div></div></div>
          </div>
        </div>

        <div class="card" style="margin-top:1rem;">
          <div class="card-header">
            <h2>üìö Student Enrollments & History</h2>
          </div>
          <div class="card-body" style="padding: 1.5rem;">
            <div class="search-bar">
              <input type="text" id="enrollments-search" placeholder="Search by student name‚Ä¶" oninput="filterStudentEnrollments()">
            </div>
            <div id="enrollments-list">
              <div class="loading"><div class="spinner"></div> Loading enrollments‚Ä¶</div>
            </div>
          </div>
        </div>
      </div>

      <!-- TEACHERS PAGE -->
      <div class="page" id="page-teachers">
        <div class="search-bar">
          <input type="text" id="teachers-search" placeholder="Search by name or email‚Ä¶" oninput="filterTable('teachers')">
        </div>
        <div class="card">
          <div class="card-header">
            <h2>Teachers</h2>
            <div class="header-actions">
              <button class="btn btn-ghost btn-sm" onclick="exportCsv('teachers')">‚¨á Export CSV</button>
              <button class="btn btn-ghost btn-sm" onclick="triggerCsvImport('teachers')">‚¨Ü Import CSV</button>
              <button class="btn btn-accent btn-sm" onclick="openTeacherModal()">+ Add Teacher</button>
            </div>
          </div>
          <div class="card-body table-wrap">
            <div id="teachers-table"><div class="loading"><div class="spinner"></div></div></div>
          </div>
        </div>

        <div class="card" style="margin-top:1rem;">
          <div class="card-header">
            <h2>üìñ Teachers & Ongoing Activities</h2>
          </div>
          <div class="card-body" style="padding: 1.5rem;">
            <div class="search-bar">
              <input type="text" id="teachers-search-activities" placeholder="Search by teacher name‚Ä¶" oninput="filterTeacherActivities()">
            </div>
            <div id="teacher-activities-list">
              <div class="loading"><div class="spinner"></div> Loading teacher activities‚Ä¶</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ACTIVITIES PAGE -->
      <div class="page" id="page-activities">
        <div class="search-bar">
          <input type="text" id="activities-search" placeholder="Search by name‚Ä¶" oninput="filterTable('activities')">
        </div>
        <div class="card">
          <div class="card-header">
            <h2>Activities</h2>
            <div class="header-actions">
              <button class="btn btn-ghost btn-sm" onclick="exportCsv('activities')">‚¨á Export CSV</button>
              <button class="btn btn-ghost btn-sm" onclick="triggerCsvImport('activities')">‚¨Ü Import CSV</button>
              <button class="btn btn-accent btn-sm" onclick="openActivityModal()">+ Add Activity</button>
            </div>
          </div>
          <div class="card-body table-wrap">
            <div id="activities-table"><div class="loading"><div class="spinner"></div></div></div>
          </div>
        </div>
      </div>

      <!-- ROOMS PAGE -->
      <div class="page" id="page-rooms">
        <div class="search-bar">
          <input type="text" id="rooms-search" placeholder="Search by name or location‚Ä¶" oninput="filterTable('rooms')">
        </div>
        <div class="card">
          <div class="card-header">
            <h2>Rooms</h2>
            <div class="header-actions">
              <button class="btn btn-ghost btn-sm" onclick="exportCsv('rooms')">‚¨á Export CSV</button>
              <button class="btn btn-ghost btn-sm" onclick="triggerCsvImport('rooms')">‚¨Ü Import CSV</button>
              <button class="btn btn-accent btn-sm" onclick="openRoomModal()">+ Add Room</button>
            </div>
          </div>
          <div class="card-body table-wrap">
            <div id="rooms-table"><div class="loading"><div class="spinner"></div></div></div>
          </div>
        </div>
      </div>

      <!-- BOOKINGS PAGE -->
      <div class="page" id="page-bookings">
        <div class="search-bar">
          <input type="text" id="bookings-search" placeholder="Search by title or room‚Ä¶" oninput="filterTable('bookings')">
        </div>
        <div class="card">
          <div class="card-header">
            <h2>Bookings</h2>
            <div class="header-actions">
              <button class="btn btn-ghost btn-sm" onclick="exportCsv('bookings')">‚¨á Export CSV</button>
              <button class="btn btn-ghost btn-sm" onclick="triggerCsvImport('bookings')">‚¨Ü Import CSV</button>
              <button class="btn btn-accent btn-sm" onclick="openBookingModal()">+ Add Booking</button>
            </div>
          </div>
          <div class="card-body table-wrap">
            <div id="bookings-table"><div class="loading"><div class="spinner"></div></div></div>
          </div>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /main -->
</div><!-- /app -->

<!-- TOAST -->
<div id="toast" class="hide"></div>

<input id="csv-file-input" type="file" accept=".csv,text/csv" style="display:none" onchange="handleCsvImport(event)">

<!-- MODALS will be injected dynamically -->
<div id="modal-container"></div>

<script>
// ===== CONFIG =====
const API = window.location.port === '3000'
  ? 'http://' + window.location.hostname + ':8000'
  : '';

// ===== STATE =====
let token = localStorage.getItem('sms_token') || null;
let currentUser = JSON.parse(localStorage.getItem('sms_user') || 'null');
let currentPage = 'dashboard';
let tableData = {};

// ===== INIT =====
document.addEventListener('DOMContentLoaded', () => {
  if (token && currentUser) {
    showApp();
  }
});

// ===== AUTH =====
function showTab(tab) {
  document.querySelectorAll('#auth-screen .tab-btn').forEach((b, i) => b.classList.toggle('active', (i === 0 ? 'login' : 'register') === tab));
  document.getElementById('login-form').style.display = tab === 'login' ? '' : 'none';
  document.getElementById('register-form').style.display = tab === 'register' ? '' : 'none';
  document.getElementById('auth-error').style.display = 'none';
}

async function doLogin(e) {
  e.preventDefault();
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  try {
    const data = await apiCall('/api/auth/login', 'POST', { username, password }, false);
    token = data.token;
    currentUser = data.user;
    localStorage.setItem('sms_token', token);
    localStorage.setItem('sms_user', JSON.stringify(currentUser));
    showApp();
  } catch(err) {
    showAuthError(err.message || 'Login failed');
  }
}

async function doRegister(e) {
  e.preventDefault();
  const username = document.getElementById('reg-username').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const password = document.getElementById('reg-password').value;
  const role = document.getElementById('reg-role').value;
  try {
    const data = await apiCall('/api/auth/register', 'POST', { username, email, password, role }, false);
    token = data.token;
    currentUser = data.user;
    localStorage.setItem('sms_token', token);
    localStorage.setItem('sms_user', JSON.stringify(currentUser));
    showApp();
  } catch(err) {
    showAuthError(err.message || 'Registration failed');
  }
}

function showAuthError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg;
  el.style.display = '';
}

function showApp() {
  document.getElementById('auth-screen').style.display = 'none';
  const app = document.getElementById('app');
  app.classList.add('visible');
  document.getElementById('user-name').textContent = currentUser?.username || 'User';
  document.getElementById('user-role').textContent = currentUser?.role || 'admin';
  document.getElementById('user-avatar').textContent = (currentUser?.username || 'U')[0].toUpperCase();
  navigate('dashboard');
}

function logout() {
  token = null;
  currentUser = null;
  localStorage.removeItem('sms_token');
  localStorage.removeItem('sms_user');
  document.getElementById('app').classList.remove('visible');
  document.getElementById('auth-screen').style.display = '';
}

// ===== NAVIGATION =====
function navigate(page) {
  currentPage = page;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  document.querySelector('[data-page="' + page + '"]').classList.add('active');
  const titles = { dashboard:'Dashboard', students:'Students', teachers:'Teachers', activities:'Activities', rooms:'Rooms', bookings:'Bookings' };
  document.getElementById('page-title').textContent = titles[page] || page;

   const topbarCenter = document.getElementById('topbar-center');
   if (topbarCenter) {
    topbarCenter.style.display = page === 'dashboard' ? 'flex' : 'none';
   }

  loadPage(page);
}

// ===== GLOBAL DATE PICKER =====
let globalSelectedDate = null;

function onGlobalDateChange() {
  const picker = document.getElementById('global-date-picker');
  globalSelectedDate = picker.value;

  selectedDate = globalSelectedDate;
  updateTimeDisplay();

  if (currentPage === 'dashboard') {
    selectedTime = null;
    renderRoomMap();
    renderTeacherList();
    generateTimeSlots();
    updateScheduleButton();

    if (document.getElementById('dashboard-calendar')?.classList.contains('active')) {
      renderCalendarView();
    }
  }
}

function initGlobalDatePicker() {
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  const todayStr = `${year}-${month}-${day}`;
  
  const picker = document.getElementById('global-date-picker');
  if (picker) {
    picker.value = todayStr;
    picker.min = todayStr;
    const maxDate = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
    const maxYear = maxDate.getFullYear();
    const maxMonth = String(maxDate.getMonth() + 1).padStart(2, '0');
    const maxDay = String(maxDate.getDate()).padStart(2, '0');
    picker.max = `${maxYear}-${maxMonth}-${maxDay}`;
  }
  globalSelectedDate = todayStr;
}

// ===== DASHBOARD TABS =====
function switchDashboardTab(tab, buttonEl) {
  document.querySelectorAll('.dashboard-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('dashboard-' + tab).classList.add('active');
  document.querySelectorAll('#page-dashboard .page-tab-btn').forEach(btn => btn.classList.remove('active'));
  if (buttonEl) buttonEl.classList.add('active');
  
  if (tab === 'calendar') {
    renderCalendarView();
  }
}

function loadPage(page) {
  if (page === 'dashboard') loadDashboard();
  else if (page === 'students') loadStudents();
  else if (page === 'teachers') loadTeachers();
  else if (page === 'activities') loadActivities();
  else if (page === 'rooms') loadRooms();
  else if (page === 'bookings') loadBookings();
}

// ===== API =====
async function apiCall(path, method = 'GET', body = null, auth = true) {
  const opts = {
    method,
    headers: { 'Content-Type': 'application/json' }
  };
  if (auth && token) opts.headers['Authorization'] = 'Bearer ' + token;
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(API + path, opts);
  const data = await res.json().catch(() => ({}));
  if (!res.ok) {
    if (res.status === 401) { logout(); return; }
    throw new Error(data.error || data.message || 'Request failed (' + res.status + ')');
  }
  return data;
}

// ===== TOAST =====
let toastTimer;
function showToast(msg, type = 'success') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = type;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.add('hide'), 3000);
}

// ===== MODAL =====
function openModal(html) {
  const c = document.getElementById('modal-container');
  c.innerHTML = html;
  document.querySelector('.modal-overlay')?.addEventListener('click', e => {
    if (e.target === e.currentTarget) closeModal();
  });
}
function closeModal() {
  document.getElementById('modal-container').innerHTML = '';
}

// ===== TABLE FILTER =====
function filterTable(entity) {
  const q = document.getElementById(entity + '-search').value.toLowerCase();
  const rows = document.querySelectorAll('#' + entity + '-table tbody tr');
  rows.forEach(row => {
    row.style.display = row.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
}

// ===== DATE FORMAT =====
function fmtDate(d) { return d ? new Date(d).toLocaleDateString() : '‚Äî'; }
function fmtDateTime(d) { return d ? new Date(d).toLocaleString() : '‚Äî'; }
function localDateKey(input) {
  const date = new Date(input);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// ===== STATUS BADGE =====
function statusBadge(s) {
  const map = {
    active:'badge-green', inactive:'badge-grey', graduated:'badge-blue', on_leave:'badge-orange',
    available:'badge-green', maintenance:'badge-orange', unavailable:'badge-red',
    pending:'badge-orange', confirmed:'badge-green', cancelled:'badge-red',
    completed:'badge-blue', enrolled:'badge-green', dropped:'badge-red'
  };
  return `<span class="badge ${map[s]||'badge-grey'}">${s||'‚Äî'}</span>`;
}

// =====================
//   DASHBOARD
// =====================
let dashboardData = { rooms: [], activities: [], teachers: [], bookings: [] };
let selectedActivity = null;
let selectedRoom = null;
let selectedTime = null;
let selectedTeacher = null;
let selectedDate = null;
let timeUpdateInterval = null;

async function loadDashboard() {
  try {
    if (!globalSelectedDate) {
      initGlobalDatePicker();
    }
    
    // Update current time display
    updateTimeDisplay();
    if (timeUpdateInterval) clearInterval(timeUpdateInterval);
    timeUpdateInterval = setInterval(updateTimeDisplay, 60000); // Update every minute
    
    const [activities, rooms, teachers, bookings] = await Promise.all([
      apiCall('/api/activities/with-enrollment'),
      apiCall('/api/rooms'),
      apiCall('/api/teachers'),
      apiCall('/api/bookings')
    ]);

    dashboardData = { rooms, activities, teachers, bookings };
    
    selectedDate = globalSelectedDate;
    
    renderRoomMap();
    renderActivityList();
    await renderTeacherList(); // Make async to check availability
    generateTimeSlots();
  } catch(err) {
    showToast(err.message, 'error');
  }
}

function updateTimeDisplay() {
  const now = new Date();
  const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
  const viewDate = selectedDate || globalSelectedDate || localDateKey(now);
  const dateStr = new Date(`${viewDate}T00:00:00`).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
  const el = document.getElementById('current-time-display');
  if (el) el.textContent = `Viewing ${dateStr} ‚Ä¢ Now ${timeStr}`;
}

function renderRoomMap() {
  const { rooms, bookings } = dashboardData;
  const selectedDay = selectedDate || globalSelectedDate;
  
  if (!rooms.length) {
    document.getElementById('room-map').innerHTML = '<div class="empty-state"><div class="icon">\ud83c\udfdb\ufe0f</div><p>No rooms configured yet</p></div>';
    return;
  }
  
  document.getElementById('room-map').innerHTML = rooms.map(room => {
    // Calculate room occupancy for selected date
    const todayBookings = bookings.filter(b => {
      const startDay = localDateKey(b.start_time);
      return b.room_id === room.id && 
             startDay === selectedDay &&
             b.status === 'confirmed';
    });
    
    let statusClass = 'available';
    let statusText = '\u2705 Available';
    let statusIcon = '\u2705';
    
    if (room.status !== 'available') {
      statusClass = 'busy';
      statusText = `\u26a0\ufe0f ${room.status === 'maintenance' ? 'Under Maintenance' : 'Unavailable'}`;
      statusIcon = '\u26a0\ufe0f';
    } else if (todayBookings.length > 0) {
      statusClass = 'partially-busy';
      statusText = `\ud83d\udcc5 ${todayBookings.length} booking${todayBookings.length > 1 ? 's' : ''} on selected date`;
      statusIcon = '\ud83d\udcc5';
    }
    
    const isSelected = selectedRoom?.id === room.id;
    
    return `
      <div class="room-tile ${statusClass} ${isSelected ? 'selected' : ''}" onclick="selectRoom(${room.id})" style="${isSelected ? 'border: 3px solid var(--primary); transform: scale(1.05);' : ''}">
        <div class="room-tile-header">
          <div class="room-name">${esc(room.name)}</div>
          <div class="room-capacity">\ud83d\udc65 ${room.capacity}</div>
        </div>
        <div class="room-status">${statusText}</div>
        ${todayBookings.length > 0 ? `
          <div class="room-bookings">
            ${todayBookings.slice(0, 2).map(b => {
              const start = new Date(b.start_time);
              const end = new Date(b.end_time);
              return `<div class="room-booking-item">
                ${start.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'})} - 
                ${end.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'})}
              </div>`;
            }).join('')}
            ${todayBookings.length > 2 ? `<div class="room-booking-item">+${todayBookings.length - 2} more</div>` : ''}
          </div>
        ` : ''}
      </div>
    `;
  }).join('');
}

function renderActivityList() {
  const { activities } = dashboardData;
  
  if (!activities.length) {
    document.getElementById('activity-list').innerHTML = '<div class="empty-state"><div class="icon">\ud83d\udcda</div><p>No activities configured</p></div>';
    return;
  }
  
  const activityIcons = ['\ud83d\udcda', '\ud83c\udfa8', '\u26bd', '\ud83c\udfb5', '\ud83d\udd2c', '\ud83d\udcbb', '\ud83c\udfad', '\ud83c\udfc0', '\u267b\ufe0f', '\ud83c\udfaf'];
  
  document.getElementById('activity-list').innerHTML = activities.map((act, idx) => {
    const enrolledCount = act.enrolled_count || 0;
    const availableSpots = act.available_spots || act.capacity;
    const percentage = Math.round((enrolledCount / act.capacity) * 100);
    const isSelected = selectedActivity?.id === act.id;
    
    return `
    <div class="activity-card ${isSelected ? 'selected' : ''}" 
         onclick="selectActivity(${act.id})" style="${isSelected ? 'box-shadow: 0 4px 12px rgba(26, 35, 126, 0.3);' : ''}">
      <div class="activity-card-header">
        <div class="activity-icon">${activityIcons[idx % activityIcons.length]}</div>
        <div class="activity-info">
          <div class="activity-name">${esc(act.name)}</div>
          <div class="activity-details">${act.description || 'No description'}</div>
          <div class="activity-capacity">\ud83c\udfaf Capacity: ${enrolledCount}/${act.capacity} (${percentage}% full)</div>
          ${act.teacher_id ? `<div class="activity-capacity" style="background: #e8f5e9;">\ud83d\udc69\u200d\ud83c\udfeb Teacher assigned</div>` : `<div class="activity-capacity" style="background: #ffebee;">\u26a0\ufe0f No teacher yet</div>`}
        </div>
      </div>
    </div>
  `;
  }).join('');
}

async function renderTeacherList() {
  const { teachers } = dashboardData;
  
  if (!teachers.length) {
    document.getElementById('dashboard-teacher-list').innerHTML = '<div class="empty-state"><div class="icon">\ud83d\udc69\u200d\ud83c\udfeb</div><p>No teachers available</p></div>';
    return;
  }
  
  // If we have a selected time, check availability
  let teacherAvailability = {};
  if (selectedTime && selectedDate) {
    const [hours, minutes] = selectedTime.split(':');
    const startTime = new Date(`${selectedDate}T${hours}:${minutes}:00`);
    const endTime = new Date(startTime.getTime() + 60 * 60 * 1000); // 1 hour duration
    
    try {
      const availableTeachers = await apiCall(`/api/teachers/available?start_time=${startTime.toISOString()}&end_time=${endTime.toISOString()}`);
      availableTeachers.forEach(t => {
        teacherAvailability[t.id] = t.available !== false;
      });
    } catch(err) {
      console.error('Failed to check teacher availability:', err);
    }
  }
  
  document.getElementById('dashboard-teacher-list').innerHTML = teachers.map(teacher => {
    const initials = `${teacher.first_name[0]}${teacher.last_name[0]}`.toUpperCase();
    const isAvailable = selectedTime && selectedDate ? (teacherAvailability[teacher.id] !== false) : (teacher.status === 'active');
    const isSelected = selectedTeacher?.id === teacher.id;
    
    return `
      <div class="teacher-card ${isAvailable ? 'available' : ''} ${isSelected ? 'selected' : ''}" 
           onclick="selectTeacher(${teacher.id})" 
           style="${isSelected ? 'border-color: var(--primary); background: #e8eaf6;' : ''}">
        <div class="teacher-card-header">
          <div class="teacher-avatar">${initials}</div>
          <div class="teacher-info">
            <div class="teacher-name">${esc(teacher.first_name)} ${esc(teacher.last_name)}</div>
            <div class="teacher-status">${esc(teacher.email)}</div>
            ${teacher.specialization ? `<div class="teacher-status" style="margin-top:0.25rem;">\ud83c\udfaf ${esc(teacher.specialization)}</div>` : ''}
          </div>
        </div>
        <div class="availability-badge ${isAvailable ? 'free' : 'busy'}">
          ${isAvailable ? '\u2713 Available' : '\u2717 Busy'}
        </div>
      </div>
    `;
  }).join('');
}

function generateTimeSlots() {
  const slots = [];
  const startHour = 8; // 8 AM
  const endHour = 18; // 6 PM
  
  for (let hour = startHour; hour < endHour; hour++) {
    slots.push(`${hour.toString().padStart(2, '0')}:00`);
    slots.push(`${hour.toString().padStart(2, '0')}:30`);
  }
  
  document.getElementById('time-grid').innerHTML = slots.map(slot => {
    const isSelected = selectedTime === slot;
    return `<div class="time-slot ${isSelected ? 'selected' : ''}" onclick="selectTime('${slot}')">${slot}</div>`;
  }).join('');
}

function updateTimeSlots() {
  // When date changes, clear the selected time and refresh time slots
  selectedTime = null;
  generateTimeSlots();
  updateScheduleButton();
}

async function selectActivity(id) {
  selectedActivity = dashboardData.activities.find(a => a.id === id);
  renderActivityList();
  
  const infoEl = document.getElementById('selected-activity-info');
  if (selectedActivity) {
    const enrolledCount = selectedActivity.enrolled_count || 0;
    infoEl.innerHTML = `<strong>Selected:</strong> ${esc(selectedActivity.name)} \u2022 Enrolled: ${enrolledCount}/${selectedActivity.capacity}`;
  }
  
  updateScheduleButton();
}

function selectRoom(id) {
  selectedRoom = dashboardData.rooms.find(r => r.id === id);
  renderRoomMap();
  showToast(`Selected: ${selectedRoom.name}`, 'info');
  updateScheduleButton();
}

async function selectTime(time) {
  selectedTime = time;
  generateTimeSlots();
  
  // Refresh teacher availability for the selected date and time
  if (selectedActivity) {
    await renderTeacherList();
  }
  
  updateScheduleButton();
}

function selectTeacher(id) {
  selectedTeacher = dashboardData.teachers.find(t => t.id === id);
  renderTeacherList();
  updateScheduleButton();
}

function updateScheduleButton() {
  const btn = document.getElementById('schedule-btn');
  const missingItems = [];
  
  if (!selectedActivity) missingItems.push('activity');
  if (!selectedRoom) missingItems.push('room');
  if (!selectedTime) missingItems.push('time');
  if (!selectedTeacher) missingItems.push('teacher');
  
  if (missingItems.length === 0) {
    btn.disabled = false;
    btn.textContent = `üìÖ Schedule ${selectedActivity.name} in ${selectedRoom.name} on ${selectedDate} at ${selectedTime}`;
  } else {
    btn.disabled = true;
    btn.textContent = `\ud83d\udcc5 Select ${missingItems.join(', ')} to schedule`;
  }
}

async function scheduleActivity() {
  if (!selectedActivity || !selectedRoom || !selectedTime || !selectedTeacher) {
    showToast('Please select activity, room, date, time, and teacher', 'error');
    return;
  }
  
  try {
    const selectedDateStr = selectedDate || globalSelectedDate;
    
    if (!selectedDateStr) {
      showToast('Please select a date', 'error');
      return;
    }
    
    const [hours, minutes] = selectedTime.split(':');
    
    // Create start and end times using the selected date
    const startDateTime = `${selectedDateStr} ${hours}:${minutes}:00`;
    const startTime = new Date(`${selectedDateStr}T${hours}:${minutes}:00`);
    const endTime = new Date(startTime.getTime() + 60 * 60 * 1000); // 1 hour duration
    const endDateTime = `${selectedDateStr} ${String(endTime.getHours()).padStart(2, '0')}:${String(endTime.getMinutes()).padStart(2, '0')}:00`;
    
    // Validate that the date/time is in the future
    if (startTime < new Date()) {
      showToast('Cannot schedule activities in the past', 'error');
      return;
    }
    
    // Show loading state
    const btn = document.getElementById('schedule-btn');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = '\u23f3 Creating booking...';
    
    // First, update the activity to assign the teacher
    if (!selectedActivity.teacher_id || selectedActivity.teacher_id !== selectedTeacher.id) {
      await apiCall(`/api/activities/${selectedActivity.id}/teacher`, 'PUT', {
        teacher_id: selectedTeacher.id
      });
    }
    
    // Then create the booking
    const booking = {
      title: selectedActivity.name,
      room_id: selectedRoom.id,
      activity_id: selectedActivity.id,
      start_time: startDateTime,  // MySQL datetime format: YYYY-MM-DD HH:MM:SS
      end_time: endDateTime,      // MySQL datetime format: YYYY-MM-DD HH:MM:SS
      status: 'confirmed'
    };
    
    await apiCall('/api/bookings', 'POST', booking);
    showToast(`\ud83c\udf89 ${selectedActivity.name} scheduled in ${selectedRoom.name} on ${selectedDateStr} at ${selectedTime}!`, 'success');
    
    // Reset selections
    selectedActivity = null;
    selectedRoom = null;
    selectedTime = null;
    selectedTeacher = null;
    
    // Reload dashboard
    await loadDashboard();
  } catch(err) {
    // Parse the error to show user-friendly message
    let errorMsg = err.message;
    
    if (err.message.includes('already booked')) {
      const date = selectedDate || globalSelectedDate || 'that time';
      errorMsg = `\u274c This room is already booked on ${date} at ${selectedTime}. Choose a different time or room.`;
    } else if (err.message.includes('Room not found')) {
      errorMsg = '\u274c Selected room is no longer available.';
    } else if (err.message.includes('not found')) {
      errorMsg = '\u274c One of the selected items is no longer available.';
    } else if (err.message.includes('past')) {
      errorMsg = '\u274c Cannot schedule activities in the past.';
    } else if (err.message.includes('datetime')) {
      errorMsg = '\u274c Invalid date or time format. Please try again.';
    }
    
    showToast(errorMsg, 'error');
    
    // Restore button state
    const btn = document.getElementById('schedule-btn');
    updateScheduleButton();
  }
}

// =====================
//   CALENDAR VIEW
// =====================
function renderCalendarView() {
  const { bookings, activities, rooms, teachers } = dashboardData;
  
  // Use calendar navigation month/year if set, otherwise use current date
  let year = calendarYear;
  let month = calendarMonth;
  if (calendarYear === undefined || calendarMonth === undefined) {
    const today = new Date(globalSelectedDate || new Date().toISOString().slice(0, 10));
    year = today.getFullYear();
    month = today.getMonth();
    calendarYear = year;
    calendarMonth = month;
  }
  
  // Calculate days in month and starting day of week
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const startDayOfWeek = firstDay.getDay();
  const daysInMonth = lastDay.getDate();
  
  let html = `
    <div class="calendar-nav">
      <button onclick="previousMonth()">‚Üê Previous</button>
      <h3>${new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</h3>
      <button onclick="nextMonth()">Next ‚Üí</button>
    </div>
    <div class="calendar-legend">
      <span style="background:#c8e6c9;color:#2e7d32;">Confirmed</span>
      <span style="background:#ffe0b2;color:#f57f17;">Pending</span>
      <span style="background:#ffcdd2;color:#d32f2f;">Cancelled</span>
    </div>
    <div class="calendar-grid">
      <div class="calendar-day-header">Sun</div>
      <div class="calendar-day-header">Mon</div>
      <div class="calendar-day-header">Tue</div>
      <div class="calendar-day-header">Wed</div>
      <div class="calendar-day-header">Thu</div>
      <div class="calendar-day-header">Fri</div>
      <div class="calendar-day-header">Sat</div>
  `;
  
  // Empty cells for days before month starts
  for (let i = 0; i < startDayOfWeek; i++) {
    html += `<div class="calendar-day other-month"></div>`;
  }
  
  // Days of the month
  const now = new Date();
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const dayDate = new Date(dateStr);
    const isToday = dayDate.toDateString() === now.toDateString();
    const dayBookings = bookings.filter(b => localDateKey(b.start_time) === dateStr);
    
    html += `<div class="calendar-day ${isToday ? 'today' : ''}">
      <div class="calendar-day-num">${day}</div>
      ${dayBookings.map(b => {
        const activity = activities.find(a => a.id === b.activity_id);
        const room = rooms.find(r => r.id === b.room_id);
        const teacher = teachers.find(t => t.id === activity?.teacher_id);
        const start = new Date(b.start_time).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        const title = `${start} ${activity?.name || 'Activity'}`;
        return `<div class="calendar-slot ${b.status}" title="${title}: ${teacher?.first_name || 'TBD'} in ${room?.name || 'Room'}">
          <strong>${start}</strong> ${activity?.name || 'Activity'}<br/>
          <small>${teacher?.first_name || 'TBD'} ‚Ä¢ ${room?.name || 'Room'}</small>
        </div>`;
      }).join('')}
    </div>`;
  }
  
  // Empty cells for days after month ends
  const totalCells = html.split('<div class="calendar-day').length - 1 - startDayOfWeek;
  for (let i = 0; i < (42 - totalCells); i++) {
    html += `<div class="calendar-day other-month"></div>`;
  }
  
  html += `</div>`;
  document.getElementById('calendar-view').innerHTML = html;
}

let calendarMonth = new Date().getMonth();
let calendarYear = new Date().getFullYear();

function previousMonth() {
  calendarMonth--;
  if (calendarMonth < 0) {
    calendarMonth = 11;
    calendarYear--;
  }
  globalSelectedDate = `${calendarYear}-${String(calendarMonth + 1).padStart(2, '0')}-01`;
  document.getElementById('global-date-picker').value = globalSelectedDate;
  renderCalendarView();
}

function nextMonth() {
  calendarMonth++;
  if (calendarMonth > 11) {
    calendarMonth = 0;
    calendarYear++;
  }
  globalSelectedDate = `${calendarYear}-${String(calendarMonth + 1).padStart(2, '0')}-01`;
  document.getElementById('global-date-picker').value = globalSelectedDate;
  renderCalendarView();
}

// =====================
//   STUDENT ENROLLMENTS
// =====================
async function loadStudentEnrollments() {
  document.getElementById('enrollments-list').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    const [students, activities, enrollments] = await Promise.all([
      apiCall('/api/students'),
      apiCall('/api/activities'),
      apiCall('/api/enrollments')
    ]);
    
    // Group enrollments by student
    const studentEnrollments = {};
    students.forEach(s => {
      studentEnrollments[s.id] = {
        student: s,
        enrollments: enrollments.filter(e => e.student_id === s.id)
      };
    });
    
    let html = '';
    Object.values(studentEnrollments).forEach(({ student, enrollments: enrolList }) => {
      if (enrolList.length === 0) return;
      
      html += `
        <div class="enrollment-card">
          <div class="enrollment-header">
            <div class="enrollment-icon">üë®‚Äçüéì</div>
            <div class="enrollment-info">
              <div class="enrollment-title">${esc(student.first_name)} ${esc(student.last_name)}</div>
              <div class="enrollment-meta">${esc(student.email)} ‚Ä¢ ID: ${student.id}</div>
            </div>
          </div>
          <div style="padding: 0.5rem 0; border-top: 1px solid var(--border); margin-top: 0.5rem; padding-top: 0.75rem;">
            <div style="font-size: 0.8rem; font-weight: 600; margin-bottom: 0.5rem;">üìö Enrolled Activities (${enrolList.length})</div>
      `;
      
      enrolList.forEach(e => {
        const activity = activities.find(a => a.id === e.activity_id);
        const statusBg = e.status === 'enrolled' ? '#e8f5e9' : e.status === 'completed' ? '#e3f2fd' : '#ffebee';
        const statusColor = e.status === 'enrolled' ? '#2e7d32' : e.status === 'completed' ? '#0097a7' : '#d32f2f';
        
        html += `
          <div style="background: ${statusBg}; padding: 0.5rem 0.75rem; border-radius: 6px; margin-bottom: 0.5rem; font-size: 0.85rem;">
            <strong style="color: ${statusColor}">${esc(activity?.name || 'Activity')}</strong>
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.2rem;">
              Status: <span style="background: white; padding: 0.2rem 0.4rem; border-radius: 4px; font-weight: 600;">${e.status}</span>
              ${e.enrollment_date ? ` ‚Ä¢ Enrolled: ${new Date(e.enrollment_date).toLocaleDateString()}` : ''}
            </div>
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
      `;
    });
    
    if (!html) {
      html = '<div class="empty-state"><div class="icon">üìö</div><p>No student enrollments found</p></div>';
    }
    
    document.getElementById('enrollments-list').innerHTML = html;
  } catch(err) {
    document.getElementById('enrollments-list').innerHTML = `<div class="alert alert-error" style="margin:0">${esc(err.message)}</div>`;
  }
}

function filterStudentEnrollments() {
  const q = document.getElementById('enrollments-search').value.toLowerCase();
  const cards = document.querySelectorAll('.enrollment-card');
  cards.forEach(card => {
    card.style.display = card.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
}

// =====================
//   TEACHER ACTIVITIES
// =====================
async function loadTeacherActivities() {
  document.getElementById('teacher-activities-list').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    const [teachers, bookings, activities, rooms] = await Promise.all([
      apiCall('/api/teachers'),
      apiCall('/api/bookings'),
      apiCall('/api/activities'),
      apiCall('/api/rooms')
    ]);
    
    const now = new Date();
    let html = '';
    
    teachers.forEach(teacher => {
      // Find activities where this teacher is assigned
      const teacherActivities = activities.filter(a => a.teacher_id === teacher.id);
      if (teacherActivities.length === 0) return;
      
      // Find bookings for those activities
      const teacherBookings = bookings.filter(b => 
        teacherActivities.some(a => a.id === b.activity_id) && b.status === 'confirmed'
      );
      
      if (teacherBookings.length === 0) return;
      
      const initials = `${teacher.first_name[0]}${teacher.last_name[0]}`.toUpperCase();
      
      html += `
        <div class="teacher-activity-card">
          <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
            <div class="teacher-avatar">${initials}</div>
            <div style="flex: 1;">
              <div style="font-weight: 700; color: var(--primary); font-size: 1rem;">${esc(teacher.first_name)} ${esc(teacher.last_name)}</div>
              <div style="font-size: 0.75rem; color: var(--text-muted);">${teacher.specialization || 'Teacher'}</div>
            </div>
          </div>
      `;
      
      teacherBookings.forEach(b => {
        const bookingTime = new Date(b.start_time);
        const endTime = new Date(b.end_time);
        const room = rooms.find(r => r.id === b.room_id);
        const activity = activities.find(a => a.id === b.activity_id);
        
        let status = 'upcoming';
        if (now > endTime) status = 'completed';
        else if (now >= bookingTime && now <= endTime) status = 'ongoing';
        
        const timeStr = bookingTime.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        
        html += `
          <div style="background: var(--bg); padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem;">
            <div class="teacher-activity-time">${timeStr} - ${endTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</div>
            <div class="teacher-activity-title">${esc(activity?.name || b.title)}</div>
            <div class="teacher-activity-room"><strong>üìç</strong> ${esc(room?.name || 'Room TBD')}</div>
            <div class="teacher-activity-status ${status}">${status.charAt(0).toUpperCase() + status.slice(1)}</div>
          </div>
        `;
      });
      
      html += `</div>`;
    });
    
    if (!html) {
      html = '<div class="empty-state"><div class="icon">üìñ</div><p>No teacher activities scheduled</p></div>';
    }
    
    document.getElementById('teacher-activities-list').innerHTML = html;
  } catch(err) {
    document.getElementById('teacher-activities-list').innerHTML = `<div class="alert alert-error" style="margin:0">${esc(err.message)}</div>`;
  }
}

function filterTeacherActivities() {
  const q = document.getElementById('teachers-search-activities').value.toLowerCase();
  const cards = document.querySelectorAll('.teacher-activity-card');
  cards.forEach(card => {
    card.style.display = card.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
}

// =====================
//   STUDENTS
// =====================
async function loadStudents() {
  document.getElementById('students-table').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    const data = await apiCall('/api/students');
    tableData.students = data;
    renderStudents(data);
    loadStudentEnrollments();
  } catch(err) {
    document.getElementById('students-table').innerHTML = `<div class="alert alert-error" style="margin:1rem">${esc(err.message)}</div>`;
  }
}

function renderStudents(data) {
  if (!data.length) {
    document.getElementById('students-table').innerHTML = '<div class="empty-state"><div class="icon">üë®‚Äçüéì</div><p>No students yet. Add your first student!</p></div>';
    return;
  }
  document.getElementById('students-table').innerHTML = `
    <table>
      <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Status</th><th>Enrolled</th><th>Actions</th></tr></thead>
      <tbody>${data.map(s=>`
        <tr>
          <td><strong>${esc(s.first_name)} ${esc(s.last_name)}</strong></td>
          <td>${esc(s.email)}</td>
          <td>${esc(s.phone||'‚Äî')}</td>
          <td>${statusBadge(s.status)}</td>
          <td>${fmtDate(s.enrollment_date)}</td>
          <td><div class="actions">
            <button class="btn btn-accent btn-sm" onclick="openEnrollmentModal(${s.id})">üìù Enroll</button>
            <button class="btn btn-ghost btn-sm" onclick='openStudentModal(${JSON.stringify(s)})'>‚úèÔ∏è Edit</button>
            <button class="btn btn-danger btn-sm" onclick="deleteStudent(${s.id})">üóëÔ∏è</button>
          </div></td>
        </tr>`).join('')}
      </tbody>
    </table>`;
}

async function openEnrollmentModal(studentId = null, multiSelect = false) {
  try {
    const [students, activities] = await Promise.all([
      apiCall('/api/students'),
      apiCall('/api/activities')
    ]);

    if (multiSelect) {
      // New multi-select mode: choose activity first, then students
      const activityOpts = activities.map(a => `<option value="${a.id}">${esc(a.name)} (cap: ${a.capacity})</option>`).join('');
      const studentCheckboxes = students.map(s => `
        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;">
          <input type="checkbox" id="student-${s.id}" value="${s.id}" class="student-checkbox">
          <label for="student-${s.id}">${esc(s.first_name)} ${esc(s.last_name)} (${esc(s.email)})</label>
        </div>
      `).join('');

      openModal(`
        <div class="modal-overlay">
          <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
              <h3>Bulk Enroll Students</h3>
              <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body">
              <div id="modal-error" class="alert alert-error" style="display:none"></div>
              <div class="form-group"><label>Activity *</label><select id="enroll-activity-bulk">${activityOpts}</select></div>
              <div class="form-group">
                <label>Students to Enroll *</label>
                <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); padding: 0.5rem; border-radius: 6px;">
                  ${studentCheckboxes}
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
              <button class="btn btn-primary" onclick="saveBulkEnrollment()">Enroll Selected</button>
            </div>
          </div>
        </div>
      `);
    } else {
      // Original single-select mode
      const studentOpts = students.map(s => `<option value="${s.id}" ${studentId === s.id ? 'selected' : ''}>${esc(s.first_name)} ${esc(s.last_name)} (${esc(s.email)})</option>`).join('');
      const activityOpts = activities.map(a => `<option value="${a.id}">${esc(a.name)} (cap: ${a.capacity})</option>`).join('');

      openModal(`
        <div class="modal-overlay">
          <div class="modal">
            <div class="modal-header">
              <h3>Register Student in Activity</h3>
              <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body">
              <div id="modal-error" class="alert alert-error" style="display:none"></div>
              <div class="form-group"><label>Student *</label><select id="enroll-student">${studentOpts}</select></div>
              <div class="form-group"><label>Activity *</label><select id="enroll-activity">${activityOpts}</select></div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
              <button class="btn btn-primary" onclick="saveEnrollment()">Register</button>
            </div>
          </div>
        </div>
      `);
    }
  } catch (err) {
    showToast(err.message, 'error');
  }
}

async function saveEnrollment() {
  const studentId = parseInt(document.getElementById('enroll-student').value);
  const activityId = parseInt(document.getElementById('enroll-activity').value);

  if (!studentId || !activityId) {
    document.getElementById('modal-error').textContent = 'Student and activity are required.';
    document.getElementById('modal-error').style.display = '';
    return;
  }

  try {
    await apiCall(`/api/activities/${activityId}/enroll`, 'POST', { student_id: studentId });
    closeModal();
    showToast('Student registered successfully');
    loadStudentEnrollments();
  } catch (err) {
    document.getElementById('modal-error').textContent = err.message;
    document.getElementById('modal-error').style.display = '';
  }
}

async function saveBulkEnrollment() {
  const activityId = parseInt(document.getElementById('enroll-activity-bulk').value);
  const selectedStudentIds = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => parseInt(cb.value));

  if (!activityId) {
    document.getElementById('modal-error').textContent = 'Activity is required.';
    document.getElementById('modal-error').style.display = '';
    return;
  }

  if (selectedStudentIds.length === 0) {
    document.getElementById('modal-error').textContent = 'Select at least one student.';
    document.getElementById('modal-error').style.display = '';
    return;
  }

  try {
    let successCount = 0;
    for (const studentId of selectedStudentIds) {
      try {
        await apiCall(`/api/activities/${activityId}/enroll`, 'POST', { student_id: studentId });
        successCount++;
      } catch (err) {
        console.warn(`Failed to enroll student ${studentId}:`, err);
      }
    }
    closeModal();
    showToast(`Enrolled ${successCount}/${selectedStudentIds.length} students`, successCount === selectedStudentIds.length ? 'success' : 'warning');
    loadStudentEnrollments();
  } catch (err) {
    document.getElementById('modal-error').textContent = err.message;
    document.getElementById('modal-error').style.display = '';
  }
}

const CSV_CONFIG = {
  students: { endpoint: '/api/students', fields: ['first_name', 'last_name', 'email', 'phone', 'address', 'date_of_birth', 'enrollment_date', 'status'] },
  teachers: { endpoint: '/api/teachers', fields: ['first_name', 'last_name', 'email', 'phone', 'specialization', 'hire_date', 'status'] },
  activities: { endpoint: '/api/activities', fields: ['name', 'description', 'teacher_id', 'room_id', 'capacity', 'start_date', 'end_date', 'schedule', 'status'] },
  rooms: { endpoint: '/api/rooms', fields: ['name', 'capacity', 'room_type', 'location', 'equipment', 'status'] },
  bookings: { endpoint: '/api/bookings', fields: ['room_id', 'activity_id', 'title', 'description', 'start_time', 'end_time', 'status', 'created_by'] }
};

let pendingCsvEntity = null;

function triggerCsvImport(entity) {
  pendingCsvEntity = entity;
  const input = document.getElementById('csv-file-input');
  input.value = '';
  input.click();
}

function csvEscape(value) {
  const text = value === null || value === undefined ? '' : String(value);
  if (text.includes(',') || text.includes('"') || text.includes('\n')) {
    return '"' + text.replace(/"/g, '""') + '"';
  }
  return text;
}

function parseCsvText(text) {
  const rows = [];
  let row = [];
  let cell = '';
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const char = text[i];
    const next = text[i + 1];

    if (char === '"') {
      if (inQuotes && next === '"') {
        cell += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (char === ',' && !inQuotes) {
      row.push(cell.trim());
      cell = '';
    } else if ((char === '\n' || char === '\r') && !inQuotes) {
      if (char === '\r' && next === '\n') i++;
      row.push(cell.trim());
      if (row.some(value => value !== '')) rows.push(row);
      row = [];
      cell = '';
    } else {
      cell += char;
    }
  }

  if (cell.length || row.length) {
    row.push(cell.trim());
    if (row.some(value => value !== '')) rows.push(row);
  }

  if (!rows.length) return [];
  const headers = rows[0].map(h => h.trim());
  return rows.slice(1).map(values => {
    const obj = {};
    headers.forEach((h, idx) => { obj[h] = values[idx] ?? ''; });
    return obj;
  });
}

async function exportCsv(entity) {
  try {
    const config = CSV_CONFIG[entity];
    const data = await apiCall(config.endpoint);
    const rows = [config.fields.join(',')];
    data.forEach(item => {
      rows.push(config.fields.map(field => csvEscape(item[field])).join(','));
    });
    const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${entity}.csv`;
    link.click();
    URL.revokeObjectURL(link.href);
    showToast(`${entity} CSV exported`, 'success');
  } catch (err) {
    showToast(err.message, 'error');
  }
}

async function handleCsvImport(event) {
  const file = event.target.files?.[0];
  if (!file || !pendingCsvEntity) return;

  try {
    const config = CSV_CONFIG[pendingCsvEntity];
    const content = await file.text();
    const parsedRows = parseCsvText(content);

    if (!parsedRows.length) {
      showToast('CSV file has no rows to import', 'error');
      return;
    }

    let successCount = 0;
    for (const row of parsedRows) {
      const payload = {};
      config.fields.forEach(field => {
        if (row[field] !== undefined && row[field] !== '') payload[field] = row[field];
      });

      if (pendingCsvEntity === 'activities' || pendingCsvEntity === 'rooms') {
        if (payload.capacity !== undefined) payload.capacity = parseInt(payload.capacity);
      }
      if (pendingCsvEntity === 'activities' || pendingCsvEntity === 'bookings') {
        if (payload.teacher_id !== undefined) payload.teacher_id = parseInt(payload.teacher_id);
        if (payload.room_id !== undefined) payload.room_id = parseInt(payload.room_id);
        if (payload.activity_id !== undefined) payload.activity_id = parseInt(payload.activity_id);
      }
      if (pendingCsvEntity === 'bookings') {
        if (payload.start_time && payload.start_time.includes('T')) payload.start_time = payload.start_time.replace('T', ' ').replace('Z', '').slice(0, 19);
        if (payload.end_time && payload.end_time.includes('T')) payload.end_time = payload.end_time.replace('T', ' ').replace('Z', '').slice(0, 19);
      }

      try {
        await apiCall(config.endpoint, 'POST', payload);
        successCount++;
      } catch (rowError) {
        console.warn(`CSV import error for row:`, row, rowError);
      }
    }

    const msg = `Imported ${successCount}/${parsedRows.length} ${pendingCsvEntity} rows`;
    console.log(msg, { successCount, total: parsedRows.length, entity: pendingCsvEntity });
    showToast(msg, successCount ? 'success' : 'error');

    if (pendingCsvEntity === 'students') loadStudents();
    if (pendingCsvEntity === 'teachers') loadTeachers();
    if (pendingCsvEntity === 'activities') loadActivities();
    if (pendingCsvEntity === 'rooms') loadRooms();
    if (pendingCsvEntity === 'bookings') loadBookings();
  } catch (err) {
    showToast(err.message, 'error');
  } finally {
    pendingCsvEntity = null;
    event.target.value = '';
  }
}

function openStudentModal(s) {
  const edit = !!s;
  openModal(`
    <div class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h3>${edit ? 'Edit Student' : 'Add Student'}</h3>
          <button class="modal-close" onclick="closeModal()">‚úï</button>
        </div>
        <div class="modal-body">
          <div id="modal-error" class="alert alert-error" style="display:none"></div>
          <div class="form-row">
            <div class="form-group"><label>First Name *</label><input id="m-fname" value="${esc(s?.first_name||'')}" required></div>
            <div class="form-group"><label>Last Name *</label><input id="m-lname" value="${esc(s?.last_name||'')}" required></div>
          </div>
          <div class="form-group"><label>Email *</label><input id="m-email" type="email" value="${esc(s?.email||'')}" required></div>
          <div class="form-row">
            <div class="form-group"><label>Phone</label><input id="m-phone" value="${esc(s?.phone||'')}"></div>
            <div class="form-group"><label>Date of Birth</label><input id="m-dob" type="date" value="${s?.date_of_birth?s.date_of_birth.substring(0,10):''}"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Enrollment Date</label><input id="m-enroll" type="date" value="${s?.enrollment_date?s.enrollment_date.substring(0,10):''}"></div>
            <div class="form-group"><label>Status</label>
              <select id="m-status">
                <option value="active" ${s?.status==='active'?'selected':''}>Active</option>
                <option value="inactive" ${s?.status==='inactive'?'selected':''}>Inactive</option>
                <option value="graduated" ${s?.status==='graduated'?'selected':''}>Graduated</option>
              </select>
            </div>
          </div>
          <div class="form-group"><label>Address</label><textarea id="m-address" rows="2">${esc(s?.address||'')}</textarea></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
          <button class="btn btn-primary" onclick="saveStudent(${s?.id||'null'})">${edit?'Save Changes':'Add Student'}</button>
        </div>
      </div>
    </div>`);
}

async function saveStudent(id) {
  const body = {
    first_name: document.getElementById('m-fname').value.trim(),
    last_name: document.getElementById('m-lname').value.trim(),
    email: document.getElementById('m-email').value.trim(),
    phone: document.getElementById('m-phone').value.trim(),
    date_of_birth: document.getElementById('m-dob').value || null,
    enrollment_date: document.getElementById('m-enroll').value || null,
    status: document.getElementById('m-status').value,
    address: document.getElementById('m-address').value.trim(),
  };
  if (!body.first_name || !body.last_name || !body.email) {
    document.getElementById('modal-error').textContent = 'First name, last name, and email are required.';
    document.getElementById('modal-error').style.display = '';
    return;
  }
  try {
    if (id) await apiCall('/api/students/' + id, 'PUT', body);
    else await apiCall('/api/students', 'POST', body);
    closeModal();
    showToast(id ? 'Student updated' : 'Student added');
    loadStudents();
  } catch(err) {
    document.getElementById('modal-error').textContent = err.message;
    document.getElementById('modal-error').style.display = '';
  }
}

async function deleteStudent(id) {
  if (!confirm('Delete this student?')) return;
  try {
    await apiCall('/api/students/' + id, 'DELETE');
    showToast('Student deleted', 'info');
    loadStudents();
  } catch(err) { showToast(err.message, 'error'); }
}

// =====================
//   TEACHERS
// =====================
async function loadTeachers() {
  document.getElementById('teachers-table').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    const data = await apiCall('/api/teachers');
    tableData.teachers = data;
    renderTeachers(data);
    loadTeacherActivities();
  } catch(err) {
    document.getElementById('teachers-table').innerHTML = `<div class="alert alert-error" style="margin:1rem">${esc(err.message)}</div>`;
  }
}

function renderTeachers(data) {
  if (!data.length) {
    document.getElementById('teachers-table').innerHTML = '<div class="empty-state"><div class="icon">üë©‚Äçüè´</div><p>No teachers yet. Add your first teacher!</p></div>';
    return;
  }
  document.getElementById('teachers-table').innerHTML = `
    <table>
      <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Specialization</th><th>Hired</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody>${data.map(t=>`
        <tr>
          <td><strong>${esc(t.first_name)} ${esc(t.last_name)}</strong></td>
          <td>${esc(t.email)}</td>
          <td>${esc(t.phone||'‚Äî')}</td>
          <td>${esc(t.specialization||'‚Äî')}</td>
          <td>${fmtDate(t.hire_date)}</td>
          <td>${statusBadge(t.status)}</td>
          <td><div class="actions">
            <button class="btn btn-ghost btn-sm" onclick='openTeacherModal(${JSON.stringify(t)})'>‚úèÔ∏è Edit</button>
            <button class="btn btn-danger btn-sm" onclick="deleteTeacher(${t.id})">üóëÔ∏è</button>
          </div></td>
        </tr>`).join('')}
      </tbody>
    </table>`;
}

function openTeacherModal(t) {
  const edit = !!t;
  openModal(`
    <div class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h3>${edit ? 'Edit Teacher' : 'Add Teacher'}</h3>
          <button class="modal-close" onclick="closeModal()">‚úï</button>
        </div>
        <div class="modal-body">
          <div id="modal-error" class="alert alert-error" style="display:none"></div>
          <div class="form-row">
            <div class="form-group"><label>First Name *</label><input id="m-fname" value="${esc(t?.first_name||'')}" required></div>
            <div class="form-group"><label>Last Name *</label><input id="m-lname" value="${esc(t?.last_name||'')}" required></div>
          </div>
          <div class="form-group"><label>Email *</label><input id="m-email" type="email" value="${esc(t?.email||'')}" required></div>
          <div class="form-row">
            <div class="form-group"><label>Phone</label><input id="m-phone" value="${esc(t?.phone||'')}"></div>
            <div class="form-group"><label>Hire Date</label><input id="m-hire" type="date" value="${t?.hire_date?t.hire_date.substring(0,10):''}"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Specialization</label><input id="m-spec" value="${esc(t?.specialization||'')}"></div>
            <div class="form-group"><label>Status</label>
              <select id="m-status">
                <option value="active" ${t?.status==='active'?'selected':''}>Active</option>
                <option value="inactive" ${t?.status==='inactive'?'selected':''}>Inactive</option>
                <option value="on_leave" ${t?.status==='on_leave'?'selected':''}>On Leave</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
          <button class="btn btn-primary" onclick="saveTeacher(${t?.id||'null'})">${edit?'Save Changes':'Add Teacher'}</button>
        </div>
      </div>
    </div>`);
}

async function saveTeacher(id) {
  const body = {
    first_name: document.getElementById('m-fname').value.trim(),
    last_name: document.getElementById('m-lname').value.trim(),
    email: document.getElementById('m-email').value.trim(),
    phone: document.getElementById('m-phone').value.trim(),
    hire_date: document.getElementById('m-hire').value || null,
    specialization: document.getElementById('m-spec').value.trim(),
    status: document.getElementById('m-status').value,
  };
  if (!body.first_name || !body.last_name || !body.email) {
    document.getElementById('modal-error').textContent = 'First name, last name, and email are required.';
    document.getElementById('modal-error').style.display = '';
    return;
  }
  try {
    if (id) await apiCall('/api/teachers/' + id, 'PUT', body);
    else await apiCall('/api/teachers', 'POST', body);
    closeModal();
    showToast(id ? 'Teacher updated' : 'Teacher added');
    loadTeachers();
  } catch(err) {
    document.getElementById('modal-error').textContent = err.message;
    document.getElementById('modal-error').style.display = '';
  }
}

async function deleteTeacher(id) {
  if (!confirm('Delete this teacher?')) return;
  try {
    await apiCall('/api/teachers/' + id, 'DELETE');
    showToast('Teacher deleted', 'info');
    loadTeachers();
  } catch(err) { showToast(err.message, 'error'); }
}

// =====================
//   ACTIVITIES
// =====================
async function loadActivities() {
  document.getElementById('activities-table').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    const data = await apiCall('/api/activities');
    tableData.activities = data;
    renderActivities(data);
  } catch(err) {
    document.getElementById('activities-table').innerHTML = `<div class="alert alert-error" style="margin:1rem">${esc(err.message)}</div>`;
  }
}

function renderActivities(data) {
  if (!data.length) {
    document.getElementById('activities-table').innerHTML = '<div class="empty-state"><div class="icon">üìö</div><p>No activities yet. Add your first activity!</p></div>';
    return;
  }
  document.getElementById('activities-table').innerHTML = `
    <table>
      <thead><tr><th>Name</th><th>Schedule</th><th>Capacity</th><th>Status</th><th>Start</th><th>End</th><th>Actions</th></tr></thead>
      <tbody>${data.map(a=>`
        <tr>
          <td><strong>${esc(a.name)}</strong><br><small style="color:#888">${esc(a.description||'')}</small></td>
          <td>${esc(a.schedule||'‚Äî')}</td>
          <td>${a.capacity}</td>
          <td>${statusBadge(a.status)}</td>
          <td>${fmtDate(a.start_date)}</td>
          <td>${fmtDate(a.end_date)}</td>
          <td><div class="actions">
            <button class="btn btn-ghost btn-sm" onclick='openActivityModal(${JSON.stringify(a)})'>‚úèÔ∏è Edit</button>
            <button class="btn btn-ghost btn-sm" onclick="openEnrollModal(${a.id})">üë• Enroll</button>
            <button class="btn btn-danger btn-sm" onclick="deleteActivity(${a.id})">üóëÔ∏è</button>
          </div></td>
        </tr>`).join('')}
      </tbody>
    </table>`;
}

async function openActivityModal(a) {
  const edit = !!a;
  let teacherOpts = '', roomOpts = '';
  try {
    const [teachers, rooms] = await Promise.all([apiCall('/api/teachers'), apiCall('/api/rooms')]);
    teacherOpts = '<option value="">‚Äî None ‚Äî</option>' + teachers.map(t => `<option value="${t.id}" ${a?.teacher_id==t.id?'selected':''}>${esc(t.first_name+' '+t.last_name)}</option>`).join('');
    roomOpts = '<option value="">‚Äî None ‚Äî</option>' + rooms.map(r => `<option value="${r.id}" ${a?.room_id==r.id?'selected':''}>${esc(r.name)}</option>`).join('');
  } catch(e) { teacherOpts = roomOpts = '<option>Failed to load</option>'; }

  openModal(`
    <div class="modal-overlay">
      <div class="modal modal-lg">
        <div class="modal-header">
          <h3>${edit ? 'Edit Activity' : 'Add Activity'}</h3>
          <button class="modal-close" onclick="closeModal()">‚úï</button>
        </div>
        <div class="modal-body">
          <div id="modal-error" class="alert alert-error" style="display:none"></div>
          <div class="form-group"><label>Activity Name *</label><input id="m-name" value="${esc(a?.name||'')}" required></div>
          <div class="form-group"><label>Description</label><textarea id="m-desc" rows="2">${esc(a?.description||'')}</textarea></div>
          <div class="form-row">
            <div class="form-group"><label>Teacher</label><select id="m-teacher">${teacherOpts}</select></div>
            <div class="form-group"><label>Room</label><select id="m-room">${roomOpts}</select></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Capacity *</label><input id="m-cap" type="number" min="1" value="${a?.capacity||''}"></div>
            <div class="form-group"><label>Schedule</label><input id="m-schedule" value="${esc(a?.schedule||'')}" placeholder="e.g. Mon/Wed 9-11am"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Start Date</label><input id="m-start" type="date" value="${a?.start_date?a.start_date.substring(0,10):''}"></div>
            <div class="form-group"><label>End Date</label><input id="m-end" type="date" value="${a?.end_date?a.end_date.substring(0,10):''}"></div>
          </div>
          <div class="form-group"><label>Status</label>
            <select id="m-status">
              <option value="active" ${a?.status==='active'?'selected':''}>Active</option>
              <option value="completed" ${a?.status==='completed'?'selected':''}>Completed</option>
              <option value="cancelled" ${a?.status==='cancelled'?'selected':''}>Cancelled</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
          <button class="btn btn-primary" onclick="saveActivity(${a?.id||'null'})">${edit?'Save Changes':'Add Activity'}</button>
        </div>
      </div>
    </div>`);
}

async function saveActivity(id) {
  const body = {
    name: document.getElementById('m-name').value.trim(),
    description: document.getElementById('m-desc').value.trim(),
    teacher_id: document.getElementById('m-teacher').value || null,
    room_id: document.getElementById('m-room').value || null,
    capacity: parseInt(document.getElementById('m-cap').value) || null,
    schedule: document.getElementById('m-schedule').value.trim(),
    start_date: document.getElementById('m-start').value || null,
    end_date: document.getElementById('m-end').value || null,
    status: document.getElementById('m-status').value,
  };
  if (!body.name || !body.capacity) {
    document.getElementById('modal-error').textContent = 'Name and capacity are required.';
    document.getElementById('modal-error').style.display = '';
    return;
  }
  try {
    if (id) await apiCall('/api/activities/' + id, 'PUT', body);
    else await apiCall('/api/activities', 'POST', body);
    closeModal();
    showToast(id ? 'Activity updated' : 'Activity added');
    loadActivities();
  } catch(err) {
    document.getElementById('modal-error').textContent = err.message;
    document.getElementById('modal-error').style.display = '';
  }
}

async function openEnrollModal(activityId) {
  let participantRows = '', studentOpts = '';
  try {
    const [participants, students] = await Promise.all([
      apiCall('/api/activities/' + activityId + '/participants'),
      apiCall('/api/students')
    ]);
    const enrolledIds = new Set(participants.map(p => p.id));
    const available = students.filter(s => !enrolledIds.has(s.id) && s.status === 'active');

    participantRows = participants.length ? participants.map(p => `
      <tr>
        <td>${esc(p.first_name+' '+p.last_name)}</td>
        <td>${esc(p.email)}</td>
        <td>${statusBadge(p.enrollment_status)}</td>
        <td><button class="btn btn-danger btn-sm" onclick="unenroll(${activityId},${p.id})">Remove</button></td>
      </tr>`).join('') : '<tr><td colspan="4" class="empty-state" style="text-align:center;padding:1rem">No enrollments yet</td></tr>';

    studentOpts = available.map(s => `<option value="${s.id}">${esc(s.first_name+' '+s.last_name)} (${esc(s.email)})</option>`).join('') ||
      '<option value="" disabled>No available students</option>';
  } catch(e) { participantRows = '<tr><td colspan="4">Error loading data</td></tr>'; }

  openModal(`
    <div class="modal-overlay">
      <div class="modal modal-lg">
        <div class="modal-header">
          <h3>Manage Enrollments ‚Äî Activity #${activityId}</h3>
          <button class="modal-close" onclick="closeModal()">‚úï</button>
        </div>
        <div class="modal-body">
          <div style="display:flex;gap:.75rem;margin-bottom:1rem;align-items:flex-end">
            <div class="form-group" style="flex:1;margin:0">
              <label>Enroll Student</label>
              <select id="enroll-student">${studentOpts}</select>
            </div>
            <button class="btn btn-accent" onclick="enrollStudent(${activityId})">Enroll</button>
          </div>
          <div id="enroll-error" class="alert alert-error" style="display:none"></div>
          <table>
            <thead><tr><th>Student</th><th>Email</th><th>Status</th><th>Action</th></tr></thead>
            <tbody id="enroll-list">${participantRows}</tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button class="btn btn-ghost" onclick="closeModal()">Close</button>
        </div>
      </div>
    </div>`);
}

async function enrollStudent(activityId) {
  const studentId = document.getElementById('enroll-student').value;
  if (!studentId) return;
  try {
    await apiCall('/api/activities/' + activityId + '/enroll', 'POST', { student_id: parseInt(studentId) });
    showToast('Student enrolled');
    closeModal();
    openEnrollModal(activityId);
  } catch(err) {
    document.getElementById('enroll-error').textContent = err.message;
    document.getElementById('enroll-error').style.display = '';
  }
}

async function unenroll(activityId, studentId) {
  if (!confirm('Remove this student from the activity?')) return;
  try {
    await apiCall('/api/activities/' + activityId + '/enroll/' + studentId, 'DELETE');
    showToast('Student removed', 'info');
    closeModal();
    openEnrollModal(activityId);
  } catch(err) { showToast(err.message, 'error'); }
}

async function deleteActivity(id) {
  if (!confirm('Delete this activity?')) return;
  try {
    await apiCall('/api/activities/' + id, 'DELETE');
    showToast('Activity deleted', 'info');
    loadActivities();
  } catch(err) { showToast(err.message, 'error'); }
}

// =====================
//   ROOMS
// =====================
async function loadRooms() {
  document.getElementById('rooms-table').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    const data = await apiCall('/api/rooms');
    tableData.rooms = data;
    renderRooms(data);
  } catch(err) {
    document.getElementById('rooms-table').innerHTML = `<div class="alert alert-error" style="margin:1rem">${esc(err.message)}</div>`;
  }
}

function renderRooms(data) {
  if (!data.length) {
    document.getElementById('rooms-table').innerHTML = '<div class="empty-state"><div class="icon">üèõÔ∏è</div><p>No rooms yet. Add your first room!</p></div>';
    return;
  }
  document.getElementById('rooms-table').innerHTML = `
    <table>
      <thead><tr><th>Name</th><th>Type</th><th>Capacity</th><th>Location</th><th>Equipment</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody>${data.map(r=>`
        <tr>
          <td><strong>${esc(r.name)}</strong></td>
          <td>${esc(r.room_type||'‚Äî')}</td>
          <td>${r.capacity}</td>
          <td>${esc(r.location||'‚Äî')}</td>
          <td><small>${esc(r.equipment||'‚Äî')}</small></td>
          <td>${statusBadge(r.status)}</td>
          <td><div class="actions">
            <button class="btn btn-ghost btn-sm" onclick='openRoomModal(${JSON.stringify(r)})'>‚úèÔ∏è Edit</button>
            <button class="btn btn-danger btn-sm" onclick="deleteRoom(${r.id})">üóëÔ∏è</button>
          </div></td>
        </tr>`).join('')}
      </tbody>
    </table>`;
}

function openRoomModal(r) {
  const edit = !!r;
  openModal(`
    <div class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h3>${edit ? 'Edit Room' : 'Add Room'}</h3>
          <button class="modal-close" onclick="closeModal()">‚úï</button>
        </div>
        <div class="modal-body">
          <div id="modal-error" class="alert alert-error" style="display:none"></div>
          <div class="form-row">
            <div class="form-group"><label>Room Name *</label><input id="m-name" value="${esc(r?.name||'')}" required></div>
            <div class="form-group"><label>Capacity *</label><input id="m-cap" type="number" min="1" value="${r?.capacity||''}"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Type</label>
              <select id="m-type">
                <option value="classroom" ${r?.room_type==='classroom'?'selected':''}>Classroom</option>
                <option value="lab" ${r?.room_type==='lab'?'selected':''}>Lab</option>
                <option value="auditorium" ${r?.room_type==='auditorium'?'selected':''}>Auditorium</option>
                <option value="gym" ${r?.room_type==='gym'?'selected':''}>Gym</option>
                <option value="library" ${r?.room_type==='library'?'selected':''}>Library</option>
                <option value="other" ${r?.room_type==='other'?'selected':''}>Other</option>
              </select>
            </div>
            <div class="form-group"><label>Status</label>
              <select id="m-status">
                <option value="available" ${r?.status==='available'?'selected':''}>Available</option>
                <option value="maintenance" ${r?.status==='maintenance'?'selected':''}>Maintenance</option>
                <option value="unavailable" ${r?.status==='unavailable'?'selected':''}>Unavailable</option>
              </select>
            </div>
          </div>
          <div class="form-group"><label>Location</label><input id="m-loc" value="${esc(r?.location||'')}"></div>
          <div class="form-group"><label>Equipment</label><textarea id="m-equip" rows="2">${esc(r?.equipment||'')}</textarea></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
          <button class="btn btn-primary" onclick="saveRoom(${r?.id||'null'})">${edit?'Save Changes':'Add Room'}</button>
        </div>
      </div>
    </div>`);
}

async function saveRoom(id) {
  const body = {
    name: document.getElementById('m-name').value.trim(),
    capacity: parseInt(document.getElementById('m-cap').value) || null,
    room_type: document.getElementById('m-type').value,
    status: document.getElementById('m-status').value,
    location: document.getElementById('m-loc').value.trim(),
    equipment: document.getElementById('m-equip').value.trim(),
  };
  if (!body.name || !body.capacity) {
    document.getElementById('modal-error').textContent = 'Name and capacity are required.';
    document.getElementById('modal-error').style.display = '';
    return;
  }
  try {
    if (id) await apiCall('/api/rooms/' + id, 'PUT', body);
    else await apiCall('/api/rooms', 'POST', body);
    closeModal();
    showToast(id ? 'Room updated' : 'Room added');
    loadRooms();
  } catch(err) {
    document.getElementById('modal-error').textContent = err.message;
    document.getElementById('modal-error').style.display = '';
  }
}

async function deleteRoom(id) {
  if (!confirm('Delete this room?')) return;
  try {
    await apiCall('/api/rooms/' + id, 'DELETE');
    showToast('Room deleted', 'info');
    loadRooms();
  } catch(err) { showToast(err.message, 'error'); }
}

// =====================
//   BOOKINGS
// =====================
async function loadBookings() {
  document.getElementById('bookings-table').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    const data = await apiCall('/api/bookings');
    tableData.bookings = data;
    renderBookings(data);
  } catch(err) {
    document.getElementById('bookings-table').innerHTML = `<div class="alert alert-error" style="margin:1rem">${esc(err.message)}</div>`;
  }
}

function renderBookings(data) {
  if (!data.length) {
    document.getElementById('bookings-table').innerHTML = '<div class="empty-state"><div class="icon">üìÖ</div><p>No bookings yet. Add your first booking!</p></div>';
    return;
  }
  document.getElementById('bookings-table').innerHTML = `
    <table>
      <thead><tr><th>Title</th><th>Room</th><th>Start</th><th>End</th><th>Status</th><th>Created By</th><th>Actions</th></tr></thead>
      <tbody>${data.map(b=>`
        <tr>
          <td><strong>${esc(b.title)}</strong>${b.description?`<br><small style="color:#888">${esc(b.description)}</small>`:''}</td>
          <td>Room #${b.room_id}</td>
          <td>${fmtDateTime(b.start_time)}</td>
          <td>${fmtDateTime(b.end_time)}</td>
          <td>${statusBadge(b.status)}</td>
          <td>${esc(b.created_by||'‚Äî')}</td>
          <td><div class="actions">
            <button class="btn btn-ghost btn-sm" onclick='openBookingModal(${JSON.stringify(b)})'>‚úèÔ∏è Edit</button>
            <button class="btn btn-danger btn-sm" onclick="deleteBooking(${b.id})">üóëÔ∏è</button>
          </div></td>
        </tr>`).join('')}
      </tbody>
    </table>`;
}

async function openBookingModal(b) {
  const edit = !!b;
  let roomOpts = '', activityOpts = '';
  try {
    const [rooms, activities] = await Promise.all([apiCall('/api/rooms'), apiCall('/api/activities')]);
    roomOpts = rooms.map(r => `<option value="${r.id}" ${b?.room_id==r.id?'selected':''}>${esc(r.name)}</option>`).join('');
    activityOpts = '<option value="">‚Äî None ‚Äî</option>' + activities.map(a => `<option value="${a.id}" ${b?.activity_id==a.id?'selected':''}>${esc(a.name)}</option>`).join('');
  } catch(e) { roomOpts = activityOpts = '<option>Error</option>'; }

  const fmtLocalDT = dt => dt ? new Date(new Date(dt) - new Date().getTimezoneOffset()*60000).toISOString().slice(0,16) : '';

  openModal(`
    <div class="modal-overlay">
      <div class="modal modal-lg">
        <div class="modal-header">
          <h3>${edit ? 'Edit Booking' : 'Add Booking'}</h3>
          <button class="modal-close" onclick="closeModal()">‚úï</button>
        </div>
        <div class="modal-body">
          <div id="modal-error" class="alert alert-error" style="display:none"></div>
          <div class="form-group"><label>Title *</label><input id="m-title" value="${esc(b?.title||'')}" required></div>
          <div class="form-group"><label>Description</label><textarea id="m-desc" rows="2">${esc(b?.description||'')}</textarea></div>
          <div class="form-row">
            <div class="form-group"><label>Room *</label><select id="m-room">${roomOpts}</select></div>
            <div class="form-group"><label>Activity</label><select id="m-activity">${activityOpts}</select></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Start Time *</label><input id="m-start" type="datetime-local" value="${fmtLocalDT(b?.start_time)}"></div>
            <div class="form-group"><label>End Time *</label><input id="m-end" type="datetime-local" value="${fmtLocalDT(b?.end_time)}"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Status</label>
              <select id="m-status">
                <option value="pending" ${b?.status==='pending'?'selected':''}>Pending</option>
                <option value="confirmed" ${b?.status==='confirmed'?'selected':''}>Confirmed</option>
                <option value="cancelled" ${b?.status==='cancelled'?'selected':''}>Cancelled</option>
              </select>
            </div>
            <div class="form-group"><label>Created By</label><input id="m-createdby" value="${esc(b?.created_by||currentUser?.username||'')}"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
          <button class="btn btn-primary" onclick="saveBooking(${b?.id||'null'})">${edit?'Save Changes':'Add Booking'}</button>
        </div>
      </div>
    </div>`);
}

async function saveBooking(id) {
  const body = {
    title: document.getElementById('m-title').value.trim(),
    description: document.getElementById('m-desc').value.trim(),
    room_id: parseInt(document.getElementById('m-room').value),
    activity_id: document.getElementById('m-activity').value ? parseInt(document.getElementById('m-activity').value) : null,
    start_time: document.getElementById('m-start').value,
    end_time: document.getElementById('m-end').value,
    status: document.getElementById('m-status').value,
    created_by: document.getElementById('m-createdby').value.trim(),
  };
  if (!body.title || !body.room_id || !body.start_time || !body.end_time) {
    document.getElementById('modal-error').textContent = 'Title, room, start time, and end time are required.';
    document.getElementById('modal-error').style.display = '';
    return;
  }
  if (new Date(body.end_time) <= new Date(body.start_time)) {
    document.getElementById('modal-error').textContent = 'End time must be after start time.';
    document.getElementById('modal-error').style.display = '';
    return;
  }
  try {
    if (id) await apiCall('/api/bookings/' + id, 'PUT', body);
    else await apiCall('/api/bookings', 'POST', body);
    closeModal();
    showToast(id ? 'Booking updated' : 'Booking created');
    loadBookings();
  } catch(err) {
    document.getElementById('modal-error').textContent = err.message;
    document.getElementById('modal-error').style.display = '';
  }
}

async function deleteBooking(id) {
  if (!confirm('Delete this booking?')) return;
  try {
    await apiCall('/api/bookings/' + id, 'DELETE');
    showToast('Booking deleted', 'info');
    loadBookings();
  } catch(err) { showToast(err.message, 'error'); }
}

// ===== UTIL =====
function esc(str) {
  if (str === null || str === undefined) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}
</script>
</body>
</html>
